<ion-header>
  <ion-toolbar>
    <ion-title>Tasks</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Search Bar -->
  <ion-searchbar
    [(ngModel)]="searchTerm"
    (ionInput)="applyFilter()"
    placeholder="Search tasks by subject or status">
  </ion-searchbar>

  <!-- Add/Edit Task Form -->
  <ion-card *ngIf="isAdding" #formContainer>
    <ion-card-header>
      <ion-card-title>{{ editingTask ? 'Edit Task' : 'Add New Task' }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="taskForm">
        <ion-item>
          <ion-label position="stacked">Subject</ion-label>
          <ion-input formControlName="subject"></ion-input>
        </ion-item>
        <div class="error" *ngIf="subjectError">{{ subjectError }}</div>

        <ion-item>
          <ion-label position="stacked">Deadline</ion-label>
          <ion-datetime
            formControlName="deadline"
            [min]="minDate">
          </ion-datetime>
        </ion-item>
        <div class="error" *ngIf="deadlineError">{{ deadlineError }}</div>

        <ion-item>
          <ion-label>Status</ion-label>
          <ion-select formControlName="status">
            <ion-select-option value="not started">Not Started</ion-select-option>
            <ion-select-option value="in progress">In Progress</ion-select-option>
            <ion-select-option value="completed">Completed</ion-select-option>
          </ion-select>
        </ion-item>

        <div class="error" *ngIf="duplicateError">{{ duplicateError }}</div>

        <ion-button expand="full" (click)="addTask()">
          {{ editingTask ? 'Update Task' : 'Add Task' }}
        </ion-button>
      </form>
    </ion-card-content>
  </ion-card>

  <ion-button expand="full" (click)="toggleAdd()" color="secondary" class="ion-margin-bottom">
    {{ isAdding ? 'Cancel' : 'Add New Task' }}
  </ion-button>

  <!-- Grouped Tasks -->
  <ng-container *ngFor="let status of ['not started', 'in progress', 'completed']">
    <ion-card *ngIf="groupedTasks[status]?.length">
      <ion-card-header>
        <ion-card-title>{{ status | titlecase }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let task of groupedTasks[status]">
            <ion-label [class.completed]="task.status === 'completed'">
              {{ task.subject }}
            </ion-label>
            <ion-note slot="end">{{ task.deadline }}</ion-note>
            <ion-select
              slot="end"
              [value]="task.status"
              (ionChange)="updateStatus(task, $event)">
              <ion-select-option value="not started">Not Started</ion-select-option>
              <ion-select-option value="in progress">In Progress</ion-select-option>
              <ion-select-option value="completed">Completed</ion-select-option>
            </ion-select>
            <ion-button fill="clear" color="danger" slot="end" (click)="deleteTask(task)">
              Delete
            </ion-button>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </ng-container>
</ion-content>
